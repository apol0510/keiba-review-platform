---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import StarRating from '../../../components/StarRating.astro';
import CategoryBadge from '../../../components/CategoryBadge.astro';
import ReviewCard from '../../../components/ReviewCard.astro';
import SiteCard from '../../../components/SiteCard.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';
import ReviewForm from '../../../components/ReviewForm';
import PricingInfo from '../../../components/PricingInfo.astro';
import OptimizedImage from '../../../components/OptimizedImage.astro';
import { getSiteBySlug, getReviewsBySiteId, getSitesWithStats, categoryLabels, getApprovedSites } from '../../../lib/airtable';
import { getScreenshotUrl, getFallbackImage } from '../../../lib/screenshot-helper';

// é™çš„ãƒ‘ã‚¹ç”Ÿæˆï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ã«å…¨ãƒšãƒ¼ã‚¸ã‚’äº‹å‰ç”Ÿæˆï¼‰
export async function getStaticPaths() {
  console.log('ğŸ”¨ ãƒ“ãƒ«ãƒ‰æ™‚: å…¨ãƒšãƒ¼ã‚¸ã‚’äº‹å‰ç”Ÿæˆã—ã¾ã™...');

  const categories = ['nankan', 'chuo', 'chihou'];
  const sites = await getApprovedSites();

  console.log(`ğŸ“„ ç”Ÿæˆãƒšãƒ¼ã‚¸æ•°: ${categories.length}ã‚«ãƒ†ã‚´ãƒª + ${sites.length}ã‚µã‚¤ãƒˆ = ${categories.length + sites.length}ãƒšãƒ¼ã‚¸`);

  const paths = [
    // ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸
    ...categories.map(category => ({
      params: { slug: category }
    })),
    // ã‚µã‚¤ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ï¼ˆå…¨ã‚µã‚¤ãƒˆã‚’äº‹å‰ç”Ÿæˆï¼‰
    ...sites.map(site => ({
      params: { slug: site.slug }
    }))
  ];

  return paths;
}

const { slug } = Astro.params;

// ã‚«ãƒ†ã‚´ãƒªä¸€è¦§
const categories = ['nankan', 'chuo', 'chihou'];
const isCategory = categories.includes(slug as string);

// Constants
const MAX_REVIEWS_TO_DISPLAY = 50;

// ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ç”¨ã®ãƒ‡ãƒ¼ã‚¿
let categoryData: {
  category: string;
  categoryLabel: string;
  sites: any[];
  sortBy: string;
  breadcrumbItems: { label: string; href?: string }[];
  description: string;
} | null = null;

// ã‚µã‚¤ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ç”¨ã®ãƒ‡ãƒ¼ã‚¿
let siteData: {
  site: any;
  reviews: any[];
  totalReviews: number;
  ratingDistribution: { rating: number; count: number; percentage: number }[];
  sortBy: string;
  filterRating: string | null;
  breadcrumbItems: { label: string; href?: string }[];
  structuredData: any;
} | null = null;

if (isCategory) {
  // ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸
  const category = slug as string;
  const categoryLabel = categoryLabels[category] || category;

  const url = new URL(Astro.request.url);
  const sortBy = url.searchParams.get('sort') || 'popular';

  const allSites = await getSitesWithStats();
  let sites = allSites.filter(s => s.category === category);

  switch (sortBy) {
    case 'newest':
      sites.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
      break;
    case 'rating':
      sites.sort((a, b) => (b.average_rating || 0) - (a.average_rating || 0));
      break;
    case 'reviews':
      sites.sort((a, b) => b.review_count - a.review_count);
      break;
    default:
      sites.sort((a, b) => b.review_count - a.review_count);
  }

  const categoryDescriptions: Record<string, string> = {
    nankan: 'å—é–¢ç«¶é¦¬ï¼ˆå¤§äº•ãƒ»å·å´ãƒ»èˆ¹æ©‹ãƒ»æµ¦å’Œï¼‰ã®äºˆæƒ³ã‚µã‚¤ãƒˆ',
    chuo: 'JRAä¸­å¤®ç«¶é¦¬ã®äºˆæƒ³ã‚µã‚¤ãƒˆ',
    chihou: 'å…¨å›½ã®åœ°æ–¹ç«¶é¦¬ã®äºˆæƒ³ã‚µã‚¤ãƒˆ'
  };

  categoryData = {
    category,
    categoryLabel,
    sites,
    sortBy,
    breadcrumbItems: [
      { label: 'ã‚µã‚¤ãƒˆä¸€è¦§', href: '/keiba-yosou/' },
      { label: categoryLabel },
    ],
    description: categoryDescriptions[category],
  };
} else {
  // ã‚µã‚¤ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸
  const site = await getSiteBySlug(slug as string);

  if (!site) {
    return Astro.redirect('/404');
  }

  const url = new URL(Astro.request.url);
  const sortBy = (url.searchParams.get('sort') as 'newest' | 'rating' | 'helpful') || 'newest';
  const filterRating = url.searchParams.get('filter_rating');

  let reviews = await getReviewsBySiteId(site.id);
  const allReviews = reviews; // è©•ä¾¡åˆ†å¸ƒç”¨ã«å…¨å£ã‚³ãƒŸã‚’ä¿æŒ

  // ã‚½ãƒ¼ãƒˆå‡¦ç†
  switch (sortBy) {
    case 'rating':
      reviews.sort((a, b) => b.rating - a.rating);
      break;
    case 'helpful':
      // ä»®å®Ÿè£…: è©•ä¾¡ãŒé«˜ã„é †
      reviews.sort((a, b) => b.rating - a.rating);
      break;
    default: // newest
      reviews.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
  }

  // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºæœ€é©åŒ–: æœ€æ–°50ä»¶ã®ã¿è¡¨ç¤ºï¼ˆå¤ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯éè¡¨ç¤ºï¼‰
  const MAX_REVIEWS_TO_DISPLAY = 50;
  const totalReviews = reviews.length;
  reviews = reviews.slice(0, MAX_REVIEWS_TO_DISPLAY);

  // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—ã—ã¦siteã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
  const reviewCount = allReviews.length;
  const averageRating = reviewCount > 0
    ? allReviews.reduce((sum, r) => sum + r.rating, 0) / reviewCount
    : undefined;

  site.reviewCount = reviewCount;
  site.averageRating = averageRating;

  // æ˜Ÿè©•ä¾¡ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  if (filterRating) {
    const rating = parseInt(filterRating);
    if (rating >= 1 && rating <= 5) {
      reviews = reviews.filter(r => r.rating === rating);
    }
  }

  // è©•ä¾¡åˆ†å¸ƒã¯å…¨å£ã‚³ãƒŸã‹ã‚‰è¨ˆç®—
  const ratingDistribution = [5, 4, 3, 2, 1].map((rating) => {
    const count = allReviews.filter((r) => r.rating === rating).length;
    const percentage = allReviews.length > 0 ? (count / allReviews.length) * 100 : 0;
    return { rating, count, percentage };
  });

  const structuredData = {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name: site.name,
    description: site.description,
    image: site.screenshotUrl,
    url: `https://keiba-review.com/keiba-yosou/${site.slug}/`,
    aggregateRating:
      reviews.length > 0 && site.averageRating
        ? {
            '@type': 'AggregateRating',
            ratingValue: site.averageRating.toFixed(1),
            reviewCount: site.reviewCount.toString(),
            bestRating: '5',
            worstRating: '1',
          }
        : undefined,
    review: reviews.slice(0, 5).map((review) => ({
      '@type': 'Review',
      author: {
        '@type': 'Person',
        name: review.username,
      },
      datePublished: review.createdAt.split('T')[0],
      reviewRating: {
        '@type': 'Rating',
        ratingValue: review.rating.toString(),
      },
      reviewBody: review.content,
    })),
  };

  siteData = {
    site,
    reviews,
    totalReviews,
    ratingDistribution,
    sortBy,
    filterRating,
    breadcrumbItems: [
      { label: 'ã‚µã‚¤ãƒˆä¸€è¦§', href: '/keiba-yosou/' },
      { label: categoryLabels[site.category], href: `/keiba-yosou/${site.category}/` },
      { label: site.name },
    ],
    structuredData,
  };
}
---

{isCategory && categoryData ? (
  <BaseLayout
    title={`${categoryData.categoryLabel}ã®äºˆæƒ³ã‚µã‚¤ãƒˆä¸€è¦§`}
    description={`${categoryData.description}ã®å£ã‚³ãƒŸãƒ»è©•åˆ¤ã‚’ç¢ºèªã€‚å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å£°ã§ä¿¡é ¼ã§ãã‚‹ã‚µã‚¤ãƒˆã‚’è¦‹ã¤ã‘ã‚ˆã†ã€‚`}
  >
    <div class="max-w-6xl mx-auto px-4 py-8">
      <Breadcrumb items={categoryData.breadcrumbItems} />

      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 mb-2">
            {categoryData.categoryLabel}ã®äºˆæƒ³ã‚µã‚¤ãƒˆ
          </h1>
          <p class="text-gray-600">{categoryData.description}</p>
        </div>
        <div class="text-sm text-gray-600 mt-4 md:mt-0">{categoryData.sites.length}ä»¶ã®ã‚µã‚¤ãƒˆ</div>
      </div>

      <!-- Sort -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-8">
        <form method="get" class="flex items-center gap-4">
          <label class="text-sm text-gray-600">ä¸¦ã³æ›¿ãˆ:</label>
          <select name="sort" class="form-input w-auto" onchange="this.form.submit()">
            <option value="popular" selected={categoryData.sortBy === 'popular'}>äººæ°—é †</option>
            <option value="rating" selected={categoryData.sortBy === 'rating'}>è©•ä¾¡é †</option>
            <option value="reviews" selected={categoryData.sortBy === 'reviews'}>å£ã‚³ãƒŸæ•°é †</option>
            <option value="newest" selected={categoryData.sortBy === 'newest'}>æ–°ç€é †</option>
          </select>
        </form>
      </div>

      <!-- Category Links -->
      <div class="flex flex-wrap gap-2 mb-8">
        <a
          href="/keiba-yosou/"
          class="px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition-colors"
        >
          ã™ã¹ã¦
        </a>
        {
          Object.entries(categoryLabels).map(([key, label]) => (
            <a
              href={`/keiba-yosou/${key}/`}
              class={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                key === categoryData!.category
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
              }`}
            >
              {label}
            </a>
          ))
        }
      </div>

      <!-- Site Grid -->
      {
        categoryData.sites.length > 0 ? (
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {categoryData.sites.map((site) => (
              <SiteCard site={site} />
            ))}
          </div>
        ) : (
          <div class="text-center py-16">
            <svg
              class="w-16 h-16 mx-auto text-gray-300 mb-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <p class="text-gray-600 mb-4">
              ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯ã¾ã ã‚µã‚¤ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
            </p>
            <a href="/keiba-yosou/" class="btn-secondary">
              ã™ã¹ã¦ã®ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹
            </a>
          </div>
        )
      }
    </div>
  </BaseLayout>
) : siteData ? (
  <BaseLayout
    title={`${siteData.site.name}ã®å£ã‚³ãƒŸãƒ»è©•åˆ¤`}
    description={`${siteData.site.name}ã®å£ã‚³ãƒŸ${siteData.site.reviewCount}ä»¶ã‚’æ²è¼‰ã€‚${siteData.site.averageRating ? `å¹³å‡è©•ä¾¡${siteData.site.averageRating.toFixed(1)}â˜…ã€‚` : ''}å®Ÿéš›ã®åˆ©ç”¨è€…ã«ã‚ˆã‚‹è©•ä¾¡ã‚’ç¢ºèªã§ãã¾ã™ã€‚`}
    ogImage={`/og/${siteData.site.slug}.png`}
  >
    <script type="application/ld+json" set:html={JSON.stringify(siteData.structuredData)} />

    <div class="max-w-6xl mx-auto px-4 py-8">
      <Breadcrumb items={siteData.breadcrumbItems} />

      <!-- Site Info Card -->
      <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
        <div class="md:flex">
          <!-- Screenshot -->
          <div class="md:w-1/3">
            <div class="aspect-video bg-gray-100 relative overflow-hidden">
              <OptimizedImage
                src={getScreenshotUrl(siteData.site.slug, siteData.site.screenshot_url)}
                alt={`${siteData.site.name}ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ`}
                width={600}
                height={400}
                loading="eager"
                class="w-full h-full object-cover"
              />
            </div>
          </div>

          <!-- Info -->
          <div class="md:w-2/3 p-6">
            <div class="flex items-start justify-between mb-4">
              <div>
                <CategoryBadge category={siteData.site.category} />
                <h1 class="text-2xl font-bold text-gray-900 mt-2">{siteData.site.name}</h1>
              </div>
            </div>

            <div class="flex items-center gap-4 mb-4">
              <StarRating rating={siteData.site.averageRating || 0} size="lg" />
              <div>
                <span class="text-2xl font-bold text-gray-900">
                  {siteData.site.averageRating ? siteData.site.averageRating.toFixed(1) : '0.0'}
                </span>
                <span class="text-gray-600">/ 5.0</span>
                <span class="text-sm text-gray-500 ml-2">({siteData.site.reviewCount}ä»¶ã®å£ã‚³ãƒŸ)</span>
              </div>
            </div>

            {siteData.site.description && <p class="text-gray-700 mb-4">{siteData.site.description}</p>}

            {
              siteData.site.features && siteData.site.features.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-4">
                  {siteData.site.features.map((feature: string) => (
                    <span class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">
                      {feature}
                    </span>
                  ))}
                </div>
              )
            }

            <a
              href={siteData.site.url}
              target="_blank"
              rel="noopener noreferrer nofollow"
              class="btn-primary inline-flex items-center gap-2"
            >
              ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                />
              </svg>
            </a>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
          <!-- Rating Distribution -->
          <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-lg font-bold text-gray-900 mb-4">è©•ä¾¡åˆ†å¸ƒ</h2>
            <div class="space-y-2">
              {
                siteData.ratingDistribution.map(({ rating, count, percentage }) => (
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600 w-8">{rating}â˜…</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-4 overflow-hidden">
                      <div
                        class="bg-amber-400 h-full rounded-full transition-all"
                        style={`width: ${percentage}%`}
                      />
                    </div>
                    <span class="text-sm text-gray-600 w-12 text-right">{count}ä»¶</span>
                  </div>
                ))
              }
            </div>
          </div>

          <!-- Reviews -->
          <div class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
              <h2 class="text-lg font-bold text-gray-900">å£ã‚³ãƒŸä¸€è¦§</h2>
              <div class="flex items-center gap-3">
                <span class="text-sm text-gray-600">
                  {siteData.reviews.length}ä»¶
                  {siteData.totalReviews > MAX_REVIEWS_TO_DISPLAY && (
                    <span class="text-gray-500">ï¼ˆæœ€æ–°{MAX_REVIEWS_TO_DISPLAY}ä»¶ã‚’è¡¨ç¤ºï¼‰</span>
                  )}
                </span>
                <form method="get" class="flex items-center gap-2">
                  <label class="text-sm text-gray-600">ä¸¦ã³æ›¿ãˆ:</label>
                  <select name="sort" class="form-input text-sm py-1 px-2 rounded border-gray-300" onchange="this.form.submit()">
                    <option value="newest" selected={siteData.sortBy === 'newest'}>æ–°ç€é †</option>
                    <option value="rating" selected={siteData.sortBy === 'rating'}>è©•ä¾¡é †</option>
                    <option value="helpful" selected={siteData.sortBy === 'helpful'}>å‚è€ƒã«ãªã£ãŸé †</option>
                  </select>
                  {siteData.filterRating && <input type="hidden" name="filter_rating" value={siteData.filterRating} />}
                </form>
              </div>
            </div>

            <!-- Star Rating Filter -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
              <div class="flex flex-wrap items-center gap-2">
                <span class="text-sm font-medium text-gray-700 mr-2">è©•ä¾¡ã§çµã‚Šè¾¼ã¿:</span>
                <a
                  href={`?${siteData.sortBy !== 'newest' ? `sort=${siteData.sortBy}` : ''}`}
                  class={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                    !siteData.filterRating
                      ? 'bg-white border-2 border-blue-600 text-blue-600 shadow-sm'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  ã™ã¹ã¦
                </a>
                {
                  [5, 4, 3, 2, 1].map((rating) => (
                    <a
                      href={`?filter_rating=${rating}${siteData.sortBy !== 'newest' ? `&sort=${siteData.sortBy}` : ''}`}
                      class={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors flex items-center gap-1 ${
                        siteData.filterRating === rating.toString()
                          ? 'bg-white border-2 border-blue-600 text-blue-600 shadow-sm'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      <span>{rating}</span>
                      <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                        <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" />
                      </svg>
                    </a>
                  ))
                }
              </div>
            </div>

            {
              siteData.reviews.length > 0 ? (
                <div class="space-y-4">
                  {siteData.reviews.map((review) => (
                    <ReviewCard review={review} />
                  ))}
                </div>
              ) : (
                <div class="bg-white rounded-lg shadow-md p-8 text-center">
                  <svg
                    class="w-12 h-12 mx-auto text-gray-300 mb-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                    />
                  </svg>
                  <p class="text-gray-600 mb-2">ã¾ã å£ã‚³ãƒŸãŒã‚ã‚Šã¾ã›ã‚“</p>
                  <p class="text-sm text-gray-500">æœ€åˆã®å£ã‚³ãƒŸã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</p>
                </div>
              )
            }
          </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
          <!-- Pricing & Service Info -->
          <PricingInfo
            pricingType={siteData.site.pricing_type}
            hasFreeTrial={siteData.site.has_free_trial}
            registrationRequired={siteData.site.registration_required}
            lastVerifiedAt={siteData.site.last_verified_at}
            isClosed={siteData.site.is_closed}
          />

          <!-- Review Form -->
          <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
            <h2 class="text-lg font-bold text-gray-900 mb-4">å£ã‚³ãƒŸã‚’æŠ•ç¨¿ã™ã‚‹</h2>
            <ReviewForm siteId={siteData.site.id} siteName={siteData.site.name} client:load />
          </div>
        </div>
      </div>
    </div>
  </BaseLayout>
) : null}
