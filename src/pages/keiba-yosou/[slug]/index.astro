---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import StarRating from '../../../components/StarRating.astro';
import CategoryBadge from '../../../components/CategoryBadge.astro';
import ReviewCard from '../../../components/ReviewCard.astro';
import SiteCard from '../../../components/SiteCard.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';
import ReviewForm from '../../../components/ReviewForm';
import PricingInfo from '../../../components/PricingInfo.astro';
import { getSiteBySlug, getReviewsBySiteId, getSitesWithStats, categoryLabels } from '../../../lib/airtable';

const { slug } = Astro.params;

// カテゴリ一覧
const categories = ['nankan', 'chuo', 'chihou', 'other'];
const isCategory = categories.includes(slug as string);

// カテゴリページ用のデータ
let categoryData: {
  category: string;
  categoryLabel: string;
  sites: any[];
  sortBy: string;
  breadcrumbItems: { label: string; href?: string }[];
  description: string;
} | null = null;

// サイト詳細ページ用のデータ
let siteData: {
  site: any;
  reviews: any[];
  ratingDistribution: { rating: number; count: number; percentage: number }[];
  sortBy: string;
  breadcrumbItems: { label: string; href?: string }[];
  structuredData: any;
} | null = null;

if (isCategory) {
  // カテゴリページ
  const category = slug as string;
  const categoryLabel = categoryLabels[category] || category;

  const url = new URL(Astro.request.url);
  const sortBy = url.searchParams.get('sort') || 'popular';

  let sites = await getSitesWithStats(category);

  switch (sortBy) {
    case 'newest':
      sites.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
      break;
    case 'rating':
      sites.sort((a, b) => b.average_rating - a.average_rating);
      break;
    case 'reviews':
      sites.sort((a, b) => b.review_count - a.review_count);
      break;
    default:
      sites.sort((a, b) => b.review_count - a.review_count);
  }

  const categoryDescriptions: Record<string, string> = {
    nankan: '南関競馬（大井・川崎・船橋・浦和）の予想サイト',
    chuo: 'JRA中央競馬の予想サイト',
    chihou: '全国の地方競馬の予想サイト',
    other: 'その他の競馬予想サイト',
  };

  categoryData = {
    category,
    categoryLabel,
    sites,
    sortBy,
    breadcrumbItems: [
      { label: 'サイト一覧', href: '/keiba-yosou/' },
      { label: categoryLabel },
    ],
    description: categoryDescriptions[category],
  };
} else {
  // サイト詳細ページ
  const site = await getSiteBySlug(slug as string);

  if (!site) {
    return Astro.redirect('/404');
  }

  const url = new URL(Astro.request.url);
  const sortBy = (url.searchParams.get('sort') as 'newest' | 'rating' | 'helpful') || 'newest';

  const reviews = await getReviewsBySiteId(site.id, sortBy);

  const ratingDistribution = [5, 4, 3, 2, 1].map((rating) => {
    const count = reviews.filter((r) => r.rating === rating).length;
    const percentage = reviews.length > 0 ? (count / reviews.length) * 100 : 0;
    return { rating, count, percentage };
  });

  const structuredData = {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name: site.name,
    description: site.description,
    image: site.screenshot_url,
    url: `https://keiba-review.com/keiba-yosou/${site.slug}/`,
    aggregateRating:
      reviews.length > 0
        ? {
            '@type': 'AggregateRating',
            ratingValue: site.average_rating.toFixed(1),
            reviewCount: site.review_count.toString(),
            bestRating: '5',
            worstRating: '1',
          }
        : undefined,
    review: reviews.slice(0, 5).map((review) => ({
      '@type': 'Review',
      author: {
        '@type': 'Person',
        name: review.user_name,
      },
      datePublished: review.created_at.split('T')[0],
      reviewRating: {
        '@type': 'Rating',
        ratingValue: review.rating.toString(),
      },
      reviewBody: review.content,
    })),
  };

  siteData = {
    site,
    reviews,
    ratingDistribution,
    sortBy,
    breadcrumbItems: [
      { label: 'サイト一覧', href: '/keiba-yosou/' },
      { label: categoryLabels[site.category], href: `/keiba-yosou/${site.category}/` },
      { label: site.name },
    ],
    structuredData,
  };
}
---

{isCategory && categoryData ? (
  <BaseLayout
    title={`${categoryData.categoryLabel}の予想サイト一覧`}
    description={`${categoryData.description}の口コミ・評判を確認。実際のユーザーの声で信頼できるサイトを見つけよう。`}
  >
    <div class="max-w-6xl mx-auto px-4 py-8">
      <Breadcrumb items={categoryData.breadcrumbItems} />

      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 mb-2">
            {categoryData.categoryLabel}の予想サイト
          </h1>
          <p class="text-gray-600">{categoryData.description}</p>
        </div>
        <div class="text-sm text-gray-600 mt-4 md:mt-0">{categoryData.sites.length}件のサイト</div>
      </div>

      <!-- Sort -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-8">
        <form method="get" class="flex items-center gap-4">
          <label class="text-sm text-gray-600">並び替え:</label>
          <select name="sort" class="form-input w-auto" onchange="this.form.submit()">
            <option value="popular" selected={categoryData.sortBy === 'popular'}>人気順</option>
            <option value="rating" selected={categoryData.sortBy === 'rating'}>評価順</option>
            <option value="reviews" selected={categoryData.sortBy === 'reviews'}>口コミ数順</option>
            <option value="newest" selected={categoryData.sortBy === 'newest'}>新着順</option>
          </select>
        </form>
      </div>

      <!-- Category Links -->
      <div class="flex flex-wrap gap-2 mb-8">
        <a
          href="/keiba-yosou/"
          class="px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition-colors"
        >
          すべて
        </a>
        {
          Object.entries(categoryLabels).map(([key, label]) => (
            <a
              href={`/keiba-yosou/${key}/`}
              class={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                key === categoryData!.category
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
              }`}
            >
              {label}
            </a>
          ))
        }
      </div>

      <!-- Site Grid -->
      {
        categoryData.sites.length > 0 ? (
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {categoryData.sites.map((site) => (
              <SiteCard site={site} />
            ))}
          </div>
        ) : (
          <div class="text-center py-16">
            <svg
              class="w-16 h-16 mx-auto text-gray-300 mb-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <p class="text-gray-600 mb-4">
              このカテゴリにはまだサイトが登録されていません
            </p>
            <a href="/keiba-yosou/" class="btn-secondary">
              すべてのサイトを見る
            </a>
          </div>
        )
      }
    </div>
  </BaseLayout>
) : siteData ? (
  <BaseLayout
    title={`${siteData.site.name}の口コミ・評判`}
    description={`${siteData.site.name}の口コミ${siteData.site.review_count}件を掲載。平均評価${siteData.site.average_rating.toFixed(1)}★。実際の利用者による評価を確認できます。`}
    ogImage={`/og/${siteData.site.slug}.png`}
  >
    <script type="application/ld+json" set:html={JSON.stringify(siteData.structuredData)} />

    <div class="max-w-6xl mx-auto px-4 py-8">
      <Breadcrumb items={siteData.breadcrumbItems} />

      <!-- Site Info Card -->
      <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
        <div class="md:flex">
          <!-- Screenshot -->
          <div class="md:w-1/3">
            <div class="aspect-video bg-gray-100">
              {
                siteData.site.screenshot_url ? (
                  <img
                    src={siteData.site.screenshot_url}
                    alt={`${siteData.site.name}のスクリーンショット`}
                    class="w-full h-full object-cover"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center text-gray-400">
                    <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                      />
                    </svg>
                  </div>
                )
              }
            </div>
          </div>

          <!-- Info -->
          <div class="md:w-2/3 p-6">
            <div class="flex items-start justify-between mb-4">
              <div>
                <CategoryBadge category={siteData.site.category} />
                <h1 class="text-2xl font-bold text-gray-900 mt-2">{siteData.site.name}</h1>
              </div>
            </div>

            <div class="flex items-center gap-4 mb-4">
              <StarRating rating={Math.round(siteData.site.average_rating)} size="lg" />
              <div>
                <span class="text-2xl font-bold text-gray-900">
                  {siteData.site.average_rating.toFixed(1)}
                </span>
                <span class="text-gray-600">/ 5.0</span>
                <span class="text-sm text-gray-500 ml-2">({siteData.site.review_count}件の口コミ)</span>
              </div>
            </div>

            {siteData.site.description && <p class="text-gray-700 mb-4">{siteData.site.description}</p>}

            {
              siteData.site.features && siteData.site.features.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-4">
                  {siteData.site.features.map((feature: string) => (
                    <span class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">
                      {feature}
                    </span>
                  ))}
                </div>
              )
            }

            <a
              href={siteData.site.url}
              target="_blank"
              rel="noopener noreferrer nofollow"
              class="btn-primary inline-flex items-center gap-2"
            >
              サイトを見る
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                />
              </svg>
            </a>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
          <!-- Rating Distribution -->
          <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-lg font-bold text-gray-900 mb-4">評価分布</h2>
            <div class="space-y-2">
              {
                siteData.ratingDistribution.map(({ rating, count, percentage }) => (
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600 w-8">{rating}★</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-4 overflow-hidden">
                      <div
                        class="bg-amber-400 h-full rounded-full transition-all"
                        style={`width: ${percentage}%`}
                      />
                    </div>
                    <span class="text-sm text-gray-600 w-12 text-right">{count}件</span>
                  </div>
                ))
              }
            </div>
          </div>

          <!-- Reviews -->
          <div class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
              <h2 class="text-lg font-bold text-gray-900">口コミ一覧</h2>
              <div class="flex items-center gap-3">
                <span class="text-sm text-gray-600">{siteData.reviews.length}件</span>
                <form method="get" class="flex items-center gap-2">
                  <label class="text-sm text-gray-600">並び替え:</label>
                  <select name="sort" class="form-input text-sm py-1 px-2 rounded border-gray-300" onchange="this.form.submit()">
                    <option value="newest" selected={siteData.sortBy === 'newest'}>新着順</option>
                    <option value="rating" selected={siteData.sortBy === 'rating'}>評価順</option>
                    <option value="helpful" selected={siteData.sortBy === 'helpful'}>参考になった順</option>
                  </select>
                </form>
              </div>
            </div>

            {
              siteData.reviews.length > 0 ? (
                <div class="space-y-4">
                  {siteData.reviews.map((review) => (
                    <ReviewCard review={review} />
                  ))}
                </div>
              ) : (
                <div class="bg-white rounded-lg shadow-md p-8 text-center">
                  <svg
                    class="w-12 h-12 mx-auto text-gray-300 mb-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                    />
                  </svg>
                  <p class="text-gray-600 mb-2">まだ口コミがありません</p>
                  <p class="text-sm text-gray-500">最初の口コミを投稿してみませんか？</p>
                </div>
              )
            }
          </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
          <!-- Pricing & Service Info -->
          <PricingInfo
            pricingType={siteData.site.pricing_type}
            hasFreeTrial={siteData.site.has_free_trial}
            registrationRequired={siteData.site.registration_required}
            lastVerifiedAt={siteData.site.last_verified_at}
            isClosed={siteData.site.is_closed}
          />

          <!-- Review Form -->
          <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
            <h2 class="text-lg font-bold text-gray-900 mb-4">口コミを投稿する</h2>
            <ReviewForm siteId={siteData.site.id} siteName={siteData.site.name} client:load />
          </div>
        </div>
      </div>
    </div>
  </BaseLayout>
) : null}
