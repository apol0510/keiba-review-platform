---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { getSitesWithStats, categoryLabels } from '../../lib/airtable';

const category = 'chuo';
const categoryLabel = categoryLabels[category];

// ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿
let sites = await getSitesWithStats();
sites = sites.filter(site => site.category === category);

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—
sites = sites.map(site => ({
  ...site,
  rankingScore: (site.average_rating || 0) * Math.log(site.review_count + 1) * 10
}));

// ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
sites.sort((a, b) => b.rankingScore - a.rankingScore);

// TOP 20ã®ã¿è¡¨ç¤º
const topSites = sites.slice(0, 20);

const breadcrumbItems = [
  { label: 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°', href: '/ranking/' },
  { label: categoryLabel }
];

const description = `${categoryLabel}ã®ç«¶é¦¬äºˆæƒ³ã‚µã‚¤ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€‚å£ã‚³ãƒŸè©•ä¾¡ã¨æŠ•ç¨¿æ•°ã‹ã‚‰ç®—å‡ºã—ãŸä¿¡é ¼æ€§ã®é«˜ã„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§ã€JRAãƒ»ä¸­å¤®ç«¶é¦¬ã«å¼·ã„ã‚µã‚¤ãƒˆã‚’æ¯”è¼ƒã§ãã¾ã™ã€‚`;
---

<BaseLayout
  title={`${categoryLabel} ç«¶é¦¬äºˆæƒ³ã‚µã‚¤ãƒˆ ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP20`}
  description={description}
>
  <div class="max-w-6xl mx-auto px-4 py-8">
    <Breadcrumb items={breadcrumbItems} />

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-3">
        ğŸ† {categoryLabel} ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP20
      </h1>
      <p class="text-gray-600 leading-relaxed">
        {categoryLabel}ã«ç‰¹åŒ–ã—ãŸç«¶é¦¬äºˆæƒ³ã‚µã‚¤ãƒˆã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å£ã‚³ãƒŸã‚’ã‚‚ã¨ã«ã€æœ¬å½“ã«ä½¿ãˆã‚‹ã‚µã‚¤ãƒˆã‚’å³é¸ã—ã¾ã—ãŸã€‚
      </p>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªãƒªãƒ³ã‚¯ -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-8 border border-blue-100">
      <h2 class="text-lg font-bold text-gray-900 mb-4">ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <div class="flex flex-wrap gap-3">
        <a
          href="/ranking/"
          class="px-5 py-2.5 rounded-full bg-white text-gray-700 text-sm font-medium border-2 border-gray-200 hover:border-blue-400 hover:text-blue-600 transition-colors shadow-sm"
        >
          ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°
        </a>
        {
          Object.entries(categoryLabels).map(([key, label]) => {
            const isActive = key === category;
            return (
              <a
                href={`/ranking/${key}/`}
                class={isActive
                  ? 'px-5 py-2.5 rounded-full bg-white text-blue-600 text-sm font-bold border-2 border-blue-600 hover:bg-blue-50 transition-colors shadow-sm'
                  : 'px-5 py-2.5 rounded-full bg-white text-gray-700 text-sm font-medium border-2 border-gray-200 hover:border-blue-400 hover:text-blue-600 transition-colors shadow-sm'}
              >
                {label}
              </a>
            );
          })
        }
      </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª¬æ˜ -->
    <div class="bg-amber-50 border-l-4 border-amber-400 p-5 mb-8 rounded-r-lg">
      <h3 class="font-bold text-amber-900 mb-2 flex items-center gap-2">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
        </svg>
        ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç®—å‡ºæ–¹æ³•
      </h3>
      <ul class="text-sm text-amber-900 space-y-1 ml-7">
        <li>â€¢ å£ã‚³ãƒŸè©•ä¾¡ï¼ˆâ­1ã€œ5ï¼‰</li>
        <li>â€¢ å£ã‚³ãƒŸæŠ•ç¨¿æ•°ï¼ˆå¤šã„ã»ã©ä¿¡é ¼æ€§ãŒé«˜ã„ï¼‰</li>
        <li>â€¢ æœ€æ–°ã®æŠ•ç¨¿çŠ¶æ³</li>
      </ul>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ -->
    <div class="space-y-4">
      {topSites.map((site, index) => {
        const rank = index + 1;
        const medalColor =
          rank === 1 ? 'text-yellow-500' :
          rank === 2 ? 'text-gray-400' :
          rank === 3 ? 'text-orange-600' :
          'text-gray-600';

        const bgClass =
          rank === 1 ? 'bg-gradient-to-r from-yellow-50 to-amber-50 border-yellow-200' :
          rank === 2 ? 'bg-gradient-to-r from-gray-50 to-slate-50 border-gray-300' :
          rank === 3 ? 'bg-gradient-to-r from-orange-50 to-red-50 border-orange-200' :
          'bg-white border-gray-200';

        return (
          <div class={`${bgClass} border-2 rounded-xl p-5 hover:shadow-lg transition-shadow`}>
            <div class="flex items-start gap-4">
              <!-- ãƒ©ãƒ³ã‚¯è¡¨ç¤º -->
              <div class="flex-shrink-0">
                {rank <= 3 ? (
                  <div class={`text-4xl font-black ${medalColor}`}>
                    {rank === 1 && 'ğŸ¥‡'}
                    {rank === 2 && 'ğŸ¥ˆ'}
                    {rank === 3 && 'ğŸ¥‰'}
                  </div>
                ) : (
                  <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center">
                    <span class="text-xl font-bold text-gray-600">{rank}</span>
                  </div>
                )}
              </div>

              <!-- ã‚µã‚¤ãƒˆæƒ…å ± -->
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-4 mb-3">
                  <div>
                    <a
                      href={`/keiba-yosou/${site.slug}/`}
                      class="text-xl font-bold text-gray-900 hover:text-blue-600 transition-colors inline-block"
                    >
                      {site.name}
                    </a>
                  </div>
                </div>

                <!-- è©•ä¾¡æƒ…å ± -->
                <div class="flex flex-wrap items-center gap-4 text-sm">
                  <div class="flex items-center gap-1">
                    <span class="text-yellow-400">{'â­'.repeat(Math.round(site.average_rating || 0))}</span>
                    <span class="font-bold text-gray-900">{(site.average_rating || 0).toFixed(1)}</span>
                  </div>
                  <div class="text-gray-600">
                    å£ã‚³ãƒŸ <span class="font-bold text-gray-900">{site.review_count}</span>ä»¶
                  </div>
                  {rank <= 3 && (
                    <div class="ml-auto">
                      <span class={`px-3 py-1 rounded-full text-xs font-bold ${
                        rank === 1 ? 'bg-yellow-200 text-yellow-900' :
                        rank === 2 ? 'bg-gray-200 text-gray-900' :
                        'bg-orange-200 text-orange-900'
                      }`}>
                        {rank === 1 ? 'ğŸ‘‘ 1ä½' : rank === 2 ? '2ä½' : '3ä½'}
                      </span>
                    </div>
                  )}
                </div>

                <!-- èª¬æ˜æ–‡ -->
                {site.description && (
                  <p class="text-sm text-gray-600 mt-3 line-clamp-2">
                    {site.description}
                  </p>
                )}

                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="mt-4 flex gap-2">
                  <a
                    href={`/keiba-yosou/${site.slug}/`}
                    class="inline-flex items-center gap-2 px-4 py-2 bg-white border-2 border-blue-600 hover:bg-blue-50 text-blue-600 text-sm font-medium rounded-lg transition-colors"
                  >
                    è©³ç´°ã‚’è¦‹ã‚‹
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </a>
                  {site.url && (
                    <a
                      href={site.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-2 px-4 py-2 bg-white border-2 border-gray-300 hover:border-gray-400 hover:bg-gray-50 text-gray-700 text-sm font-medium rounded-lg transition-colors"
                    >
                      å…¬å¼ã‚µã‚¤ãƒˆ
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                      </svg>
                    </a>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      })}
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ CTA -->
    <div class="mt-12 text-center bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-8 border border-blue-100">
      <h2 class="text-2xl font-bold text-gray-900 mb-3">
        ä»–ã®ã‚«ãƒ†ã‚´ãƒªã‚‚è¦‹ã¦ã¿ã‚‹
      </h2>
      <p class="text-gray-600 mb-6">
        ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚„ä»–ã®ã‚«ãƒ†ã‚´ãƒªã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚‚ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ã€‚
      </p>
      <div class="flex flex-wrap justify-center gap-3">
        <a
          href="/ranking/"
          class="inline-flex items-center gap-2 px-6 py-3 bg-white border-2 border-blue-600 hover:bg-blue-50 text-blue-600 font-bold rounded-lg transition-colors shadow-sm"
        >
          ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
        <a
          href="/keiba-yosou/chuo/"
          class="inline-flex items-center gap-2 px-6 py-3 bg-white border-2 border-gray-300 hover:border-gray-400 hover:bg-gray-50 text-gray-700 font-medium rounded-lg transition-colors"
        >
          {categoryLabel}ã®å…¨ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹
        </a>
      </div>
    </div>
  </div>
</BaseLayout>
