---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getSitesWithStats, getLatestReviews } from '../../lib/airtable';

// 統計データ取得
const sites = await getSitesWithStats();
const reviews = await getLatestReviews(100);

const totalSites = sites.length;
const totalReviews = sites.reduce((sum, s) => sum + s.review_count, 0);
---

<BaseLayout title="管理ガイド">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold text-gray-900 mb-8">管理ガイド</h1>

    <!-- Stats -->
    <div class="grid grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow p-6 text-center">
        <p class="text-3xl font-bold text-blue-600">{totalSites}</p>
        <p class="text-sm text-gray-600">登録サイト</p>
      </div>
      <div class="bg-white rounded-lg shadow p-6 text-center">
        <p class="text-3xl font-bold text-green-600">{totalReviews}</p>
        <p class="text-sm text-gray-600">口コミ数</p>
      </div>
    </div>

    <!-- Airtable Link -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <h2 class="text-lg font-bold text-gray-900 mb-4">データ管理</h2>
      <p class="text-gray-600 mb-4">
        サイトと口コミの管理はAirtableで行います。
        以下のリンクからAirtableを開いてください。
      </p>
      <a
        href="https://airtable.com"
        target="_blank"
        rel="noopener noreferrer"
        class="btn-primary inline-flex items-center gap-2"
      >
        Airtableを開く
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
        </svg>
      </a>
    </div>

    <!-- Instructions -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-bold text-gray-900 mb-4">操作方法</h2>

      <div class="space-y-6">
        <div>
          <h3 class="font-medium text-gray-900 mb-2">口コミの承認</h3>
          <ol class="text-sm text-gray-600 list-decimal list-inside space-y-1">
            <li>Airtableの「Reviews」テーブルを開く</li>
            <li>IsApproved が空のレコードを確認</li>
            <li>内容を確認し、問題なければ IsApproved にチェック</li>
            <li>スパムの場合は IsSpam にチェック</li>
            <li>⭐️ 料金情報の提案があれば確認（SuggestedPricingType, SuggestedHasFreeTrial, SuggestedRegistrationRequired）</li>
          </ol>
        </div>

        <div>
          <h3 class="font-medium text-gray-900 mb-2">料金情報の更新（口コミからの提案）</h3>
          <ol class="text-sm text-gray-600 list-decimal list-inside space-y-1">
            <li>「Reviews」テーブルで SuggestedPricingType が入力されているレコードを確認</li>
            <li>提案内容が正しいか判断</li>
            <li>「Sites」テーブルで該当サイトを開く</li>
            <li>PricingType, HasFreeTrial, RegistrationRequired を手動で更新</li>
            <li>複数の提案がある場合は、より信頼性の高い情報を採用</li>
          </ol>
          <p class="text-xs text-gray-500 mt-2">
            💡 ヒント: Reviewsテーブルをフィルタリング（SuggestedPricingType is not empty）すると、料金提案のある口コミだけを表示できます
          </p>
        </div>

        <div>
          <h3 class="font-medium text-gray-900 mb-2">サイトの追加</h3>
          <ol class="text-sm text-gray-600 list-decimal list-inside space-y-1">
            <li>Airtableの「Sites」テーブルを開く</li>
            <li>新規レコードを追加</li>
            <li>Name, URL, Slug, Category を入力</li>
            <li>IsApproved にチェックで公開</li>
          </ol>
        </div>

        <div>
          <h3 class="font-medium text-gray-900 mb-2">統計の更新</h3>
          <p class="text-sm text-gray-600">
            ReviewCount, AverageRating は手動で更新するか、
            Airtableの数式フィールドを設定してください。
          </p>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
