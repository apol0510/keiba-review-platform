---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getAirtableConfig, categoryLabels } from '../../lib/airtable';
import Airtable from 'airtable';

const { isDemoMode, apiKey, baseId } = await getAirtableConfig();

let pendingSites: any[] = [];

if (!isDemoMode && apiKey && baseId) {
  try {
    Airtable.configure({ apiKey });
    const base = Airtable.base(baseId);

    const records = await base('Sites')
      .select({
        filterByFormula: '{IsApproved} = FALSE()',
        sort: [{ field: 'CreatedAt', direction: 'desc' }],
      })
      .all();

    pendingSites = records.map(record => ({
      id: record.id,
      name: record.fields.Name,
      url: record.fields.URL,
      slug: record.fields.Slug,
      category: record.fields.Category,
      description: record.fields.Description,
      submitterName: record.fields.SubmitterName,
      submitterEmail: record.fields.SubmitterEmail,
      createdAt: record._rawJson.createdTime,
    }));
  } catch (error) {
    console.error('Error fetching pending sites:', error);
  }
}
---

<BaseLayout title="æœªæ‰¿èªã‚µã‚¤ãƒˆä¸€è¦§ - ç®¡ç†ç”»é¢" description="æœªæ‰¿èªã‚µã‚¤ãƒˆã®ç®¡ç†">
  <div class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">æœªæ‰¿èªã‚µã‚¤ãƒˆä¸€è¦§</h1>
          <p class="text-gray-600">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ç™»éŒ²ã•ã‚ŒãŸã‚µã‚¤ãƒˆã‚’ç¢ºèªã—ã€æ‰¿èªã¾ãŸã¯å´ä¸‹ã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>
        {pendingSites.length > 0 && (
          <div class="text-right">
            <p class="text-sm text-gray-600 mb-2">
              æœªæ‰¿èªã‚µã‚¤ãƒˆ: <span class="font-bold text-lg text-blue-600">{pendingSites.length}ä»¶</span>
            </p>
            <button
              id="bulk-approve-btn"
              class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium shadow-md"
            >
              ğŸ“¦ å…¨ã¦æ‰¿èªï¼ˆä¸€æ‹¬ï¼‰
            </button>
          </div>
        )}
      </div>
    </div>

    {pendingSites.length === 0 ? (
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
        <p class="text-gray-600">æœªæ‰¿èªã®ã‚µã‚¤ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
      </div>
    ) : (
      <div class="space-y-6">
        {pendingSites.map((site) => (
          <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
            <div class="flex justify-between items-start mb-4">
              <div class="flex-1">
                <h2 class="text-xl font-bold text-gray-900 mb-2">{site.name}</h2>
                <div class="flex items-center gap-4 text-sm text-gray-600 mb-2">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    {categoryLabels[site.category] || site.category}
                  </span>
                  <span>æŠ•ç¨¿: {new Date(site.createdAt).toLocaleDateString('ja-JP')}</span>
                </div>
                <a
                  href={site.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-blue-600 hover:underline text-sm"
                >
                  {site.url} â†—
                </a>
              </div>
            </div>

            <div class="mb-4">
              <h3 class="text-sm font-medium text-gray-700 mb-1">èª¬æ˜</h3>
              <p class="text-gray-600 whitespace-pre-wrap">{site.description}</p>
            </div>

            <div class="mb-4 bg-gray-50 p-3 rounded">
              <h3 class="text-sm font-medium text-gray-700 mb-1">æŠ•ç¨¿è€…æƒ…å ±</h3>
              <div class="text-sm text-gray-600">
                <p>åå‰: {site.submitterName}</p>
                <p>ãƒ¡ãƒ¼ãƒ«: {site.submitterEmail}</p>
              </div>
            </div>

            <div class="border-t pt-4 mt-4">
              <h3 class="text-sm font-medium text-gray-700 mb-3">æ‰¿èªè¨­å®š</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    ã‚«ãƒ†ã‚´ãƒª <span class="text-red-600">*</span>
                  </label>
                  <select
                    data-site-id={site.id}
                    class="category-select w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    required
                  >
                    <option value="" selected={site.category === 'other'}>é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="chuo" selected={site.category === 'chuo'}>ä¸­å¤®ç«¶é¦¬ï¼ˆJRAï¼‰</option>
                    <option value="nankan" selected={site.category === 'nankan'}>å—é–¢ç«¶é¦¬</option>
                    <option value="chihou" selected={site.category === 'chihou'}>åœ°æ–¹ç«¶é¦¬</option>
                  </select>
                  <p class="text-xs text-red-500 mt-1">
                    â€»å¿…é ˆï¼šæ‰¿èªå‰ã«å¿…ãšé¸æŠ
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    ã‚µã‚¤ãƒˆå“è³ª
                  </label>
                  <select
                    data-site-id={site.id}
                    class="quality-select w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="normal">é€šå¸¸ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</option>
                    <option value="excellent">å„ªè‰¯ã‚µã‚¤ãƒˆ</option>
                    <option value="malicious">æ‚ªè³ªã‚µã‚¤ãƒˆ</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    è¡¨ç¤ºå„ªå…ˆåº¦
                  </label>
                  <input
                    type="number"
                    data-site-id={site.id}
                    class="priority-input w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    value="50"
                    min="0"
                    max="999"
                    placeholder="1-999 (å¤§ãã„ã»ã©ä¸Šä½)"
                  />
                  <p class="text-xs text-gray-500 mt-1">
                    å„ªè‰¯: 100-200 / é€šå¸¸: 50 / æ‚ªè³ª: 0-10
                  </p>
                </div>
              </div>
              <div class="flex gap-3">
                <button
                  data-action="approve"
                  data-site-id={site.id}
                  data-site-url={site.url}
                  class="approve-btn px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 font-medium"
                >
                  âœ“ æ‰¿èªã—ã¦ã‚¹ã‚¯ã‚·ãƒ§å–å¾—
                </button>
                <button
                  data-action="reject"
                  data-site-id={site.id}
                  class="reject-btn px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500"
                >
                  âœ— å´ä¸‹
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>
    )}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ä¸€æ‹¬æ‰¿èªãƒœã‚¿ãƒ³
      const bulkApproveBtn = document.getElementById('bulk-approve-btn');
      if (bulkApproveBtn) {
        bulkApproveBtn.addEventListener('click', async () => {
          const approveButtons = document.querySelectorAll('.approve-btn');
          const totalSites = approveButtons.length;

          if (!confirm(`${totalSites}ä»¶ã®ã‚µã‚¤ãƒˆã‚’ä¸€æ‹¬æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯å–å¾—ã•ã‚Œã¾ã›ã‚“ã€‚å¾Œã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚`)) {
            return;
          }

          bulkApproveBtn.disabled = true;
          bulkApproveBtn.textContent = 'å‡¦ç†ä¸­... 0/' + totalSites;

          let approved = 0;
          let failed = 0;

          for (const btn of approveButtons) {
            const button = btn as HTMLButtonElement;
            const siteId = button.dataset.siteId;

            try {
              // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ãªã—ã§æ‰¿èªï¼ˆIsApprovedã®ã¿å¤‰æ›´ï¼‰
              const response = await fetch('/api/admin/bulk-approve-site', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ siteId }),
              });

              if (response.ok) {
                approved++;
                button.textContent = 'âœ… æ‰¿èªæ¸ˆã¿';
                button.disabled = true;
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-gray-400');
              } else {
                failed++;
                button.textContent = 'âŒ å¤±æ•—';
              }
            } catch (error) {
              failed++;
              button.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
            }

            bulkApproveBtn.textContent = `å‡¦ç†ä¸­... ${approved + failed}/${totalSites}`;

            // APIåˆ¶é™ã‚’è€ƒæ…®ã—ã¦å°‘ã—å¾…æ©Ÿ
            await new Promise(resolve => setTimeout(resolve, 100));
          }

          bulkApproveBtn.textContent = `å®Œäº†: ${approved}ä»¶æ‰¿èªã€${failed}ä»¶å¤±æ•—`;

          setTimeout(() => {
            alert(`ä¸€æ‹¬æ‰¿èªå®Œäº†\n\næˆåŠŸ: ${approved}ä»¶\nå¤±æ•—: ${failed}ä»¶\n\næ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:\nnode scripts/capture-screenshots.js ã‚’å®Ÿè¡Œã—ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚`);
            window.location.reload();
          }, 1000);
        });
      }

      // æ‰¿èªãƒœã‚¿ãƒ³ï¼ˆå€‹åˆ¥ï¼‰
      document.querySelectorAll('.approve-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const button = e.target as HTMLButtonElement;
          const siteId = button.dataset.siteId;
          const siteUrl = button.dataset.siteUrl;

          // åŒã˜ã‚µã‚¤ãƒˆIDã®å€¤ã‚’å–å¾—
          const categorySelect = document.querySelector(`.category-select[data-site-id="${siteId}"]`) as HTMLSelectElement;
          const qualitySelect = document.querySelector(`.quality-select[data-site-id="${siteId}"]`) as HTMLSelectElement;
          const priorityInput = document.querySelector(`.priority-input[data-site-id="${siteId}"]`) as HTMLInputElement;

          const category = categorySelect?.value;
          const siteQuality = qualitySelect?.value || 'normal';
          const displayPriority = parseInt(priorityInput?.value || '50', 10);

          // ã‚«ãƒ†ã‚´ãƒªãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (!category || category === '') {
            alert('âš ï¸ ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ï¼\n\nä¸­å¤®ç«¶é¦¬ï¼ˆJRAï¼‰ã€å—é–¢ç«¶é¦¬ã€åœ°æ–¹ç«¶é¦¬ã®ã„ãšã‚Œã‹ã‚’é¸æŠã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
            categorySelect?.focus();
            return;
          }

          if (!confirm('ã“ã®ã‚µã‚¤ãƒˆã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’è‡ªå‹•å–å¾—ã—ã¾ã™ï¼‰')) return;

          button.disabled = true;
          button.textContent = 'å‡¦ç†ä¸­...';

          try {
            const response = await fetch('/api/admin/approve-site', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                siteId,
                siteUrl,
                category,
                siteQuality,
                displayPriority
              }),
            });

            if (!response.ok) {
              throw new Error('æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            alert('ã‚µã‚¤ãƒˆã‚’æ‰¿èªã—ã¾ã—ãŸ');
            window.location.reload();
          } catch (error) {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error as Error).message);
            button.disabled = false;
            button.textContent = 'âœ“ æ‰¿èªã—ã¦ã‚¹ã‚¯ã‚·ãƒ§å–å¾—';
          }
        });
      });

      // å´ä¸‹ãƒœã‚¿ãƒ³
      document.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const button = e.target as HTMLButtonElement;
          const siteId = button.dataset.siteId;

          if (!confirm('ã“ã®ã‚µã‚¤ãƒˆã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) return;

          button.disabled = true;
          button.textContent = 'å‡¦ç†ä¸­...';

          try {
            const response = await fetch('/api/admin/reject-site', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ siteId }),
            });

            if (!response.ok) {
              throw new Error('å´ä¸‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            alert('ã‚µã‚¤ãƒˆã‚’å´ä¸‹ã—ã¾ã—ãŸ');
            window.location.reload();
          } catch (error) {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error as Error).message);
            button.disabled = false;
            button.textContent = 'âœ— å´ä¸‹';
          }
        });
      });
    });
  </script>
</BaseLayout>
