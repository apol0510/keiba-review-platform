---
import StarRating from './StarRating.astro';
import CategoryBadge from './CategoryBadge.astro';
import type { SiteWithStats } from '../lib/airtable';

interface Props {
  site: SiteWithStats;
}

const { site } = Astro.props;
---

<div class="relative bg-white rounded-lg shadow-md overflow-hidden card-hover group">
  <a href={`/keiba-yosou/${site.slug}/`} class="block">
  <div class="aspect-video bg-gray-100 relative overflow-hidden">
    {
      site.screenshot_url ? (
        <img
          src={site.screenshot_url.replace('/width/1200/', '/width/600/')}
          alt={`${site.name}のスクリーンショット`}
          class="w-full h-full object-cover transition-opacity duration-300"
          loading="lazy"
          decoding="async"
          width="600"
          height="400"
          onload="this.style.opacity='1'"
          style="opacity: 0; background-color: #f3f4f6;"
        />
      ) : (
        <div class="w-full h-full flex items-center justify-center text-gray-400">
          <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
            />
          </svg>
        </div>
      )
    }
    <div class="absolute top-2 left-2">
      <CategoryBadge category={site.category} size="sm" />
    </div>
  </div>
  <div class="p-4">
    <h3 class="font-bold text-gray-900 mb-2 line-clamp-1">{site.name}</h3>
    <div class="flex items-center gap-2 mb-2">
      <StarRating rating={Math.round(site.average_rating)} size="sm" />
      <span class="text-sm text-gray-600">
        {site.average_rating.toFixed(1)} ({site.review_count}件)
      </span>
    </div>
    {
      site.description && (
        <p class="text-sm text-gray-600 line-clamp-2">{site.description}</p>
      )
    }
  </div>
  </a>

  <!-- 比較に追加ボタン -->
  <div class="px-4 pb-4">
    <button
      type="button"
      class="compare-btn w-full py-2 text-sm text-blue-600 bg-blue-50 hover:bg-blue-100 rounded border border-blue-200 transition-colors"
      data-site-slug={site.slug}
      data-site-name={site.name}
    >
      <span class="compare-add">比較に追加</span>
      <span class="compare-remove hidden">比較から削除</span>
    </button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const COMPARE_KEY = 'compare_sites';
    const MAX_COMPARE = 3;

    // localStorage から比較リストを取得
    function getCompareList(): string[] {
      const stored = localStorage.getItem(COMPARE_KEY);
      return stored ? JSON.parse(stored) : [];
    }

    // localStorage に比較リストを保存
    function saveCompareList(list: string[]) {
      localStorage.setItem(COMPARE_KEY, JSON.stringify(list));
      updateCompareBar();
    }

    // 比較バーを更新
    function updateCompareBar() {
      const list = getCompareList();
      let compareBar = document.getElementById('compare-bar');

      if (list.length > 0) {
        if (!compareBar) {
          // 比較バーを作成
          compareBar = document.createElement('div');
          compareBar.id = 'compare-bar';
          compareBar.className = 'fixed bottom-0 left-0 right-0 bg-blue-600 text-white p-4 shadow-lg z-40';
          compareBar.innerHTML = `
            <div class="max-w-6xl mx-auto flex items-center justify-between">
              <div>
                <span class="font-bold">比較リスト:</span>
                <span id="compare-count">${list.length}</span>件選択中
              </div>
              <div class="flex gap-2">
                <button id="clear-compare-btn" class="px-4 py-2 bg-white text-blue-600 rounded hover:bg-gray-100">
                  クリア
                </button>
                <a href="/compare?${list.map(s => `site=${s}`).join('&')}" class="px-4 py-2 bg-white text-blue-600 rounded hover:bg-gray-100">
                  比較する (${list.length}件)
                </a>
              </div>
            </div>
          `;
          document.body.appendChild(compareBar);

          // クリアボタンのイベント
          document.getElementById('clear-compare-btn')?.addEventListener('click', () => {
            localStorage.removeItem(COMPARE_KEY);
            compareBar?.remove();
            updateAllButtons();
          });
        } else {
          // 既存の比較バーを更新
          const countSpan = compareBar.querySelector('#compare-count');
          if (countSpan) countSpan.textContent = list.length.toString();

          const compareLink = compareBar.querySelector('a[href^="/compare"]');
          if (compareLink) {
            compareLink.setAttribute('href', `/compare?${list.map(s => `site=${s}`).join('&')}`);
            compareLink.textContent = `比較する (${list.length}件)`;
          }
        }
      } else {
        compareBar?.remove();
      }
    }

    // すべてのボタンの状態を更新
    function updateAllButtons() {
      const list = getCompareList();
      document.querySelectorAll('.compare-btn').forEach((btn) => {
        const slug = btn.getAttribute('data-site-slug');
        const isSelected = slug && list.includes(slug);

        const addSpan = btn.querySelector('.compare-add');
        const removeSpan = btn.querySelector('.compare-remove');

        if (isSelected) {
          addSpan?.classList.add('hidden');
          removeSpan?.classList.remove('hidden');
          btn.classList.add('bg-blue-200', 'border-blue-400');
          btn.classList.remove('bg-blue-50', 'border-blue-200');
        } else {
          addSpan?.classList.remove('hidden');
          removeSpan?.classList.add('hidden');
          btn.classList.remove('bg-blue-200', 'border-blue-400');
          btn.classList.add('bg-blue-50', 'border-blue-200');
        }
      });
    }

    // 比較ボタンのクリックイベント
    document.querySelectorAll('.compare-btn').forEach((button) => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const slug = button.getAttribute('data-site-slug');
        const name = button.getAttribute('data-site-name');

        if (!slug) return;

        let list = getCompareList();

        if (list.includes(slug)) {
          // 削除
          list = list.filter(s => s !== slug);
        } else {
          // 追加
          if (list.length >= MAX_COMPARE) {
            alert(`比較できるサイトは最大${MAX_COMPARE}件までです`);
            return;
          }
          list.push(slug);
        }

        saveCompareList(list);
        updateAllButtons();
      });
    });

    // 初期化
    updateCompareBar();
    updateAllButtons();
  });
</script>
