---
interface Props {
  rating: number;
  maxRating?: number;
  size?: 'sm' | 'md' | 'lg';
  showValue?: boolean;
}

const { rating, maxRating = 5, size = 'md', showValue = false } = Astro.props;

const sizeClasses = {
  sm: 'w-4 h-4',
  md: 'w-5 h-5',
  lg: 'w-6 h-6',
};

const stars = Array.from({ length: maxRating }, (_, i) => i + 1);

// 評価を0.5刻みに切り捨て
// 1.0~1.4 → 1.0, 1.5~1.9 → 1.5, 2.0~2.4 → 2.0, 2.5~2.9 → 2.5, 3.0~3.4 → 3.0, 3.5~3.9 → 3.5, etc.
function roundToHalf(rating: number): number {
  // 浮動小数点の誤差を考慮（0.001未満の誤差は無視）
  // 2.9999 → 3.0として扱う
  const adjusted = Math.round(rating * 1000) / 1000;

  // 例: 2.7 → 2.7*2=5.4 → floor(5.4)=5 → 5/2=2.5
  // 例: 2.8 → 2.8*2=5.6 → floor(5.6)=5 → 5/2=2.5
  // 例: 3.0 → 3.0*2=6.0 → floor(6.0)=6 → 6/2=3.0
  // 例: 2.999 → 3.0*2=6.0 → floor(6.0)=6 → 6/2=3.0（誤差補正）
  // 例: 3.8 → 3.8*2=7.6 → floor(7.6)=7 → 7/2=3.5
  return Math.floor(adjusted * 2) / 2;
}

// 星の状態を判定（full, half, empty）
function getStarType(starNumber: number, rating: number): 'full' | 'half' | 'empty' {
  const roundedRating = roundToHalf(rating);
  const decimal = roundedRating % 1; // 小数部分を取得

  if (starNumber <= Math.floor(roundedRating)) {
    return 'full';
  } else if (starNumber === Math.floor(roundedRating) + 1 && decimal === 0.5) {
    // 0.5の場合のみ半星表示
    return 'half';
  } else {
    return 'empty';
  }
}
---

<div class="flex items-center gap-0.5">
  {
    stars.map((star) => {
      const starType = getStarType(star, rating);
      return (
        <div class={`relative ${sizeClasses[size]}`}>
          {starType === 'full' ? (
            <svg
              class="star-filled"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
          ) : starType === 'half' ? (
            <>
              <svg
                class="star-empty absolute inset-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
              </svg>
              <svg
                class="star-filled absolute inset-0"
                fill="currentColor"
                viewBox="0 0 20 20"
                style="clip-path: inset(0 50% 0 0);"
              >
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
              </svg>
            </>
          ) : (
            <svg
              class="star-empty"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
          )}
        </div>
      );
    })
  }
  {showValue && <span class="ml-1 text-gray-600 text-sm">{rating.toFixed(1)}</span>}
</div>
