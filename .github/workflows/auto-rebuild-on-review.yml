name: Auto Rebuild on New Review

# å£ã‚³ãƒŸæŠ•ç¨¿æ™‚ã«è‡ªå‹•ã§ã‚µã‚¤ãƒˆã‚’å†ãƒ“ãƒ«ãƒ‰
on:
  schedule:
    # æ¯æ—¥AM6æ™‚ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆæ–°ã—ã„å£ã‚³ãƒŸãŒã‚ã‚Œã°å†ãƒ“ãƒ«ãƒ‰ï¼‰
    # auto-post-reviews.ymlï¼ˆAM4:00ï¼‰ã®2æ™‚é–“å¾Œã«å®Ÿè¡Œã—ã¦APIè¡çªã‚’å›é¿
    - cron: '0 21 * * *' # UTC 21:00 = JST 06:00
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-and-rebuild:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check for new reviews
        id: check
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        run: node scripts/check-new-reviews.cjs

      - name: Build
        if: steps.check.outputs.should_rebuild == 'true'
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
          NODE_OPTIONS: --max-old-space-size=4096
        run: npm run build
        timeout-minutes: 30

      - name: Deploy to Netlify
        if: steps.check.outputs.should_rebuild == 'true'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          npm install -g netlify-cli
          netlify deploy --prod --dir=dist --message "Auto rebuild: New reviews detected"

      - name: Notify completion
        if: steps.check.outputs.should_rebuild == 'true'
        run: |
          echo "ğŸ‰ ã‚µã‚¤ãƒˆãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼"
          echo "ğŸ“… æ¬¡å›ãƒã‚§ãƒƒã‚¯: æ˜æ—¥ AM5:00"
